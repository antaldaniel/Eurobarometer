---
title: "Working With Metadata"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Working With Metadata}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
library(knitr)
```

```{r setup, message=FALSE}
library(eurobarometer)
library(dplyr)
library(stringr)
```

The `eb_sample` is a small fraction of the GESIS datafile `ZA5479_v6-0-0.sav`.  It cannot be used to retrieve any statistical data from the original dataset.  In scope it is limited to some important metadata columns, a few demographic variables and one question block.  In geographic coverage, it takes a sample from the responses from the United Kingdom and Germany. These two countries are targeting parts of the countries separately, i.e. for Great Britain and Northern Ireland, and the former West Germany and East Germany. 

```{r}
data ( "eb_sample", package = "eurobarometer")
eb_sample$filename <- 'eb_sample'
sample_metadata <- gesis_metadata_create(eb_sample)
names(sample_metadata)
```

The function `gesis_metadta_create` normalizes those variable names that are not machine readable, using two functions under the hood (see: `?label_normalize` and `?label_suggest`.) 

These names are still often problematic and require adjustment.

```{r}
adjusted_metadata <- sample_metadata %>%
  mutate ( var_name_suggested = case_when (
    str_sub(var_label_norm, 1,3) == "p6_|p7_" ~
      str_sub(var_label_norm, 4,-1), 
    var_label_norm == "w1_weight_result_from_target" ~ 'w1', 
    TRUE ~ var_label_norm )
    )
```

You can, if you know what you are doing, change the suggested base R representation of your survey data in the column:


```{r, eval=FALSE}
renamed_sample <- sample %>%
  purrr::set_names ( adjusted_metadata$var_name_suggested)

converted <- convert_class (dat = renamed_sample, 
               metadata = adjusted_metadata,
               var_name = "var_name_suggested",
               conversion = "class_suggested")

converted %>%
  dplyr::select( 
    all_of(c("w1","age_exact", 
             "energy_saving_action_used_car_less"))
    ) %>%
  dplyr::sample_n(., 10) %>%
  kable()
```

`GESIS` and/or `TNS` did not use some variable names consistently over the years and decades.  Canonizing these variables names is a subjective matter. A subjective canonization is coded in `?label_suggest`, which uses both the variable names and their labels from the SPSS file.

```{r, eval=FALSE}
sample_metadata$var_name_suggested  <- label_suggest(
  var_name_orig = sample_metadata$var_name_orig, 
  var_label_orig = sample_metadata$var_label_orig                       )

sample %>%
  purrr::set_names ( sample_metadata$var_name_suggested) %>%
  dplyr::select ( starts_with("age")) %>%
  dplyr::sample_n(10) %>%
  kable()

```
